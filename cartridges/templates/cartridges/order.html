{% extends "cartridges/base.html" %}

{% block title %}–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<!-- –ë–ª–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫–∞–∑–∞ -->
{% if order_items %}
<div class="card mb-4">
    <div class="card-header bg-warning text-white">–ù—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å</div>
    <table class="table table-bordered">
        <thead class="table-dark">
        <tr>
            <th>–ê—Ä—Ç–∏–∫—É–ª</th>
            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
            <th>–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
            <th>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</th>
            <th>–ù—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å</th>
        </tr>
        </thead>
        <tbody>
        {% for item in order_items %}
        <tr>
            <td>{{ item.cartridge.article }}</td>
            <td>{{ item.cartridge.name }}</td>
            <td>{{ item.current }}</td>
            <td>{{ item.minimum }}</td>
            <td>{{ item.needed }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–∫–∞–∑–∞</p>
{% endif %}

<!-- –§–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">–î–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–∫–∞–∑ –≤—Ä—É—á–Ω—É—é</div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            {{ formset.management_form }}
            <table class="table table-bordered" id="formset-table">
                <thead>
                <tr>
                    <th>–ö–∞—Ä—Ç—Ä–∏–¥–∂</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–£–¥–∞–ª–∏—Ç—å</th>
                </tr>
                </thead>
                <tbody>
                {% for form in formset %}
                <tr>
                    <td>
                        {{ form.cartridge }}
                        {{ form.cartridge.errors }}
                    </td>
                    <td>
                        {{ form.quantity }}
                        {{ form.quantity.errors }}
                    </td>
                    <td>
                        {% if formset.can_delete %}
                        {{ form.DELETE }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'index' %}" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
        </form>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <button id="add-more" class="btn btn-outline-primary mt-3">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë</button>
    </div>
</div>

<!-- –≠–∫—Å–ø–æ—Ä—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
<div class="d-flex gap-2">
    <a href="{% url 'export_order_to_excel' %}" class="btn btn-success">üì• –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</a>
    <a href="{% url 'send_order_email' %}" class="btn btn-primary">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–æ—á—Ç—É</a>
</div>

<!-- –®–∞–±–ª–æ–Ω —Å—Ç—Ä–æ–∫–∏ -->
<script type="text/template" id="empty-row">
    <tr>
        <td>
            <select name="{{ formset.prefix }}-__prefix__-cartridge" class="form-select">
                {% for cart in cartridges %}
                <option value="{{ cart.id }}">{{ cart.name }} ({{ cart.article }})</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="{{ formset.prefix }}-__prefix__-quantity" class="form-control" min="1">
        </td>
        <td>
            <input type="checkbox" name="{{ formset.prefix }}-__prefix__-DELETE" class="form-check-input">
        </td>
    </tr>
</script>

<!-- JS –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function () {
        let formCount = {{ formset.total_form_count }};
        $('#add-more').click(function () {
            const row = $('#empty-row').html()
                .replace(/__prefix__/g, formCount);
            $('#formset-table tbody').append(row);
            formCount++;
        });
    });
</script>
{% endblock %}