{% extends "cartridges/base.html" %}

{% block title %}–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ -->
{% if order_items %}
<div class="card mb-4">
    <div class="card-header bg-warning text-white">–ù—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å</div>
    <table class="table table-bordered">
        <thead class="table-dark">
        <tr>
            <th>–ê—Ä—Ç–∏–∫—É–ª</th>
            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
            <th>–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
            <th>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</th>
            <th>–ù—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å</th>
        </tr>
        </thead>
        <tbody>
        {% for item in order_items %}
        <tr>
            <td>{{ item.cartridge.article }}</td>
            <td>{{ item.cartridge.name }}</td>
            <td>{{ item.current }}</td>
            <td>{{ item.minimum }}</td>
            <td>{{ item.needed }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–∫–∞–∑–∞</p>
{% endif %}

<!-- –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">–î–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–∫–∞–∑ –≤—Ä—É—á–Ω—É—é</div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            {{ formset.management_form }}
            <table class="table table-bordered" id="formset-table">
                <thead>
                <tr>
                    <th>–ö–∞—Ä—Ç—Ä–∏–¥–∂</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–£–¥–∞–ª–∏—Ç—å</th>
                </tr>
                </thead>
                <tbody>
                {% for form in formset %}
                <tr>
                    <td>{{ form.cartridge }}</td>
                    <td>{{ form.quantity }}</td>
                    <td>
                        {% if formset.can_delete %}
                        {{ form.DELETE }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'index' %}" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
        </form>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <button id="add-more" class="btn btn-outline-primary mt-3">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë</button>
    </div>
</div>

<!-- –≠–∫—Å–ø–æ—Ä—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
<div class="d-flex gap-2">
    <a href="{% url 'export_order_to_excel' %}" class="btn btn-success">üì• –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</a>
    <a href="{% url 'send_order_email' %}" class="btn btn-primary">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–æ—á—Ç—É</a>
</div>

<!-- –°–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è JS -->
<div id="empty-row" style="display: none;">
    <div class="row">
        <div class="col-md-5">
            <select name="{{ formset.prefix }}-__prefix__-cartridge" class="form-select">
                <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã –≤ JS -->
            </select>
        </div>
        <div class="col-md-5">
            <input type="number" name="{{ formset.prefix }}-__prefix__-quantity" class="form-control" min="1">
        </div>
        <div class="col-md-2">
            <input type="checkbox" name="{{ formset.prefix }}-__prefix__-DELETE" class="form-check-input">
        </div>
    </div>
</div>

<!-- –ë–ª–æ–∫ —Å –æ–ø—Ü–∏—è–º–∏ –¥–ª—è cartridge -->
<div id="cartridge-options" style="display: none;">
    <select>
        {% for cart in cartridges %}
        <option value="{{ cart.id }}">{{ cart.name }} ({{ cart.article }})</option>
        {% endfor %}
    </select>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º jQuery –∏ JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function () {
        let formCount = {{ formset.total_form_count }};
        const $tableBody = $('#formset-table tbody');
        const $emptyRow = $('#empty-row').clone();

        $('#add-more').click(function () {
            const $newRow = $emptyRow.clone();
            $newRow.find('input, select').each(function () {
                const name = $(this).attr('name').replace('__prefix__', formCount);
                const id = $(this).attr('id').replace('__prefix__', formCount);
                $(this).attr('name', name).attr('id', id).val('');

                // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º <select> cartridge
                if ($(this).is('select[name$="-cartridge"]')) {
                    $(this).html($('#cartridge-options select').html());
                }
            });
            $tableBody.append($newRow);
            formCount++;
        });
    });
</script>
{% endblock %}